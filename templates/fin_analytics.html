<template>
    <style>

        .visual{
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            padding-bottom: 30px;
        }

        .visual fieldset{
            margin-top: 0;
            min-width: 250px;
        }

        .visual-periodo{
            flex-direction: column;
        }


    </style>

    <div class="top">
        <h4>Visualizações</h4>

        <div class="visual">

            <fieldset>
                <legend>Movimentação</legend>
                <div class="inline">
                    <label for="ckbEntrada">Entradas</label>
                    <input type="checkbox" id="ckbEntrada" checked>
                </div>
    
                <div class="inline">
                    <label for="ckbSaida">Saídas</label>
                    <input type="checkbox" id="ckbSaida" checked>
                </div>
                </fieldset>
                <fieldset>
                <legend>Gráficos</legend>
                <div class="inline">
                    <label for="rbtTotal">Total no Peróodo</label>
                    <input type="radio" name="graph" id="rbtTotal" checked>
                </div>
                <div class="inline">
                    <label for="rbtDist">Dist. no Tempo</label>
                    <input type="radio" name="graph" id="rbtDist">
                </div>

            </fieldset>
            <fieldset class="">
                <legend>Período</legend>
                <div class="inline visual-periodo">
                    <input type="date" id="edtIni" onkeypress="return getEnter(event, 'btnBusca')">
                    <input type="date" id="edtFin" onkeypress="return getEnter(event, 'btnBusca')">
                    <div class="inline">
                        <label for="ckbData">no período:</label>
                        <input type="checkbox" id="ckbData" checked>
                    </div>
                </div>
            </fieldset>

        </div>

    </div>

    <hr>    

    <h4>Análise</h4>

    <div class="tab-bar">
        <div class="tab-item" id="tab-tabela"   onclick="pictab(this)">Dados       </div>
        <div class="tab-item" id="tab-custos"    onclick="pictab(this)">Custos     </div>
        <div class="tab-item" id="tab-comp"     onclick="pictab(this)">Ent/Saida     </div>            
    </div>
    <div class="tab-screen">        
        <div id="tabela" class="tab">
            <table id="tblDados"></table>
        </div>
        <div id="custos" class="tab">
            <div id="piechart" style="width: 100%; height: 100%;"></div>
        </div>
        <div id="comp" class="tab"></div>
    </div>


</template>
<script>
    const pageData = main_data.fin_analytics.data
    const pageFunc = main_data.fin_analytics.func
    const pageScreen = document.querySelector('#card-fin_analytics')
    var chart 


    function pageStart(){
        pageScreen.querySelector('#tab-tabela').click()
        
        loadExternalScript("https://www.gstatic.com/charts/loader.js",'google_chart').then((resolve, reject)=>{
            pageFunc.fillData()
        })        

        pageScreen.querySelector('#edtIni').value = today.iniMonth()
        pageScreen.querySelector('#edtFin').value = today.finMonth()
        
    }

    pageFunc.fillData = ()=>{
        const ckb = pageScreen.querySelector('#ckbData').checked ? 1 : 0 
        const params = new Object
            params.entrada = pageScreen.querySelector('#ckbEntrada').checked ? 'ENTRADA' : 'NULL'
            params.saida = pageScreen.querySelector('#ckbSaida').checked ? 'SAIDA' : 'NULL'
            params.dt_ini = !ckb ? '0000-00-00' : pageScreen.querySelector('#edtIni').value
            params.dt_fin = !ckb ? '9999-12-31' : pageScreen.querySelector('#edtFin').value
        const myPromisse = queryDB(params,'FIN-12')
        myPromisse.then((resolve)=>{
            const json = JSON.parse(resolve)
            pageData.dados = json
            const tbl = pageScreen.querySelector('#tblDados')
            tbl.head('Data,Ent/Sai,Credor,Devedor,Desc.,Valor,Saldo')
            pageData.centro_custo = [['Centro de Custo', 'Valor']]
            for(let i=0; i<json.length; i++){
                tbl.plot(json[i],'venc,modalidade,credor,devedor,nome,valor,saldo','dat,Upp,Upp,Upp,Upp,R$.,R$.')
                if(json[i].modalidade == 'SAÍDA'){
                    if(!pageData.centro_custo.some(A => A[0] === json[i].centro_custo) ){                   
                        pageData.centro_custo.push([json[i].centro_custo,Number(json[i].valor) * -1])
                    }else{
                        pageData.centro_custo[json[i].centro_custo] += (Number(json[i].valor) * -1)
                    }
                }                
            }
            pageFunc.fillCustos()
        })
        return myPromisse
    }

    pageFunc.fillCustos = ()=>{
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(drawChart);

        function drawChart() {
            console.log(pageData)
//            for(let )

            var data = google.visualization.arrayToDataTable(pageData.centro_custo);

            var options = {
                title: `Gráfico de Custos de ${pageScreen.querySelector('#edtIni').value.date()} a ${pageScreen.querySelector('#edtFin').value.date()}`
            };

            var chart = new google.visualization.PieChart(document.getElementById('piechart'))

            setTimeout(function() {
                chart.draw(data, options)
            }, 1000);

        }

    }

    pageScreen.querySelector('#ckbEntrada').addEventListener('change',()=>{
        pageFunc.fillData()        
    })

    pageScreen.querySelector('#ckbSaida').addEventListener('change',()=>{
        pageFunc.fillData()        
    })

    pageScreen.querySelector('#edtIni').addEventListener('change',()=>{
        pageFunc.fillData()        
    })

    pageScreen.querySelector('#edtFin').addEventListener('change',()=>{
        pageFunc.fillData()        
    })

    pageStart()

</script>